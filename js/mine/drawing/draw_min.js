var drawObj=function(){var e=this;e.canvasID="canvas",e.canvWidth=300,e.canvHeight=300,e.canvas=null,e.prevScale=1,e.unit=50,e.sel_obj=null,e.init=function(a,t){e.objArr=[],e.canvWidth=a,e.canvHeight=t,e.canvasCSS(),e.initFabric(),e.drawEvent(),e.objEvent()},e.canvasCSS=function(){$("#"+e.canvasID).attr("width",e.canvWidth),$("#"+e.canvasID).attr("height",e.canvHeight),$("#"+e.canvasID).css("width",e.canvWidth),$("#"+e.canvasID).css("height",e.canvHeight),e.canvas&&(e.canvas.setWidth(e.canvWidth),e.canvas.setHeight(e.canvHeight),e.canvas.renderAll(),e.canvas.calcOffset())},e.initFabric=function(){e.canvas=new fabric.Canvas(e.canvasID)},e.drawEvent=function(){$("#"+e.canvasID).droppable({drop:function(a,t){var r=$(t.draggable).children("img").attr("src"),c=1*$("#canvas_area").css("left").replace("px",""),s=1*$("#canvas_area").css("top").replace("px",""),o=t.helper.offset().left-c,n=t.helper.offset().top-s-50;e.addObject("svg",o,n,r)}})},e.objEvent=function(){e.canvas.on("object:moving",function(a){var t=e.canvas.getActiveObject();e.isSnap(t)}),e.canvas.on("object:selected",function(a){var t=e.canvas.getActiveObject();t.c_angle=t.angle}),e.canvas.on("object:rotating",function(a){var t=e.canvas.getActiveObject();t.c_angle=t.angle})},e.addObject=function(a,t,r,c,s,o){switch(a){case"text":e.canvas.add(new fabric.Text("Add Text",{left:t,top:r,fill:"black",scaleX:e.prevScale,scaleY:e.prevScale}));break;case"line":e.canvas.add(new fabric.Rect({type:"rect",left:t,top:r,width:150,height:10,fill:"white",stroke:1,borderColor:"black",hasBorders:!0,scaleX:e.prevScale,scaleY:e.prevScale}));break;case"rect":e.canvas.add(new fabric.Rect({type:"rect",left:t,top:r,width:150,height:100,fill:"white",stroke:2,borderColor:"black",hasBorders:!0,scaleX:e.prevScale,scaleY:e.prevScale}));break;case"triangle":e.canvas.add(new fabric.Triangle({type:"triangle",left:t,top:r,width:100,height:100,fill:"white",stroke:2,borderColor:"black",hasBorders:!0,scaleX:e.prevScale,scaleY:e.prevScale}));break;case"circle":e.canvas.add(new fabric.Circle({type:"circle",left:t,top:r,radius:50,fill:"white",stroke:2,borderColor:"black",hasBorders:!0,scaleX:e.prevScale,scaleY:e.prevScale}));break;case"star":for(var n,l,i=0,b=0,v=[],h=0;h<10;h++)i=h%2==0?100:40,b=2*Math.PI/10*h,n=t-Math.sin(b)*i,l=r-Math.cos(b)*i,v.push({x:n,y:l});e.canvas.add(new fabric.Polygon(v,{type:"star",left:t,top:r,fill:"purple",fill:"white",stroke:2,borderColor:"black",hasBorders:!0,points:v,scaleX:e.prevScale,scaleY:e.prevScale}));break;case"ellipse":e.canvas.add(new fabric.Ellipse({type:"ellipse",left:t,top:r,rx:50,ry:30,fill:"white",stroke:2,originX:"center",originY:"center",borderColor:"black",hasBorders:!0,scaleX:e.prevScale,scaleY:e.prevScale}));break;case"image":var f="img/objs/2d_shape/"+c,s=s.split(","),p=o;fabric.Image.fromURL(f,function(a){e.canvas.add(a.set({top:r,left:t,url:f,width:s[0]*e.unit,height:s[1]*e.unit,depth:s[2],obj3d:p,scaleX:e.prevScale,scaleY:e.prevScale}))});break;case"svg":fabric.loadSVGFromURL(c,function(a,c){var s=fabric.util.groupSVGElements(a,c),o=[],n=[];o.push(s),n=[2,4,15,24];for(var l=0;l<n.length;l++){var i=new fabric.Ellipse({type:"ellipse",top:a[n[l]].y1,left:a[n[l]].x1,rx:10,ry:10,fill:"black",originX:"center",originY:"center",visible:!1});o.push(i)}var b=new fabric.Group(o,{top:r,left:t,index:e.objArr.length});b.setControlsVisibility({mt:!1,mb:!1,ml:!1,mr:!1,bl:!1,br:!1,tl:!1,tr:!1}),e.objArr.push(b),e.canvas.add(b)})}e.isSnap=function(a){for(var t=[],r=null,c=null,s=0;s<e.objArr.length;s++)if(a.index!=e.objArr[s].index){t=[];for(var o=1;o<e.objArr[s]._objects.length;o++)for(var n=1;n<a._objects.length&&(o==n||(r=e.getAbsolutePosition(a._objects[n]),c=e.getAbsolutePosition(e.objArr[s]._objects[o]),Math.abs(r.x-c.x)<20&&Math.abs(r.y-c.y)<20&&t.push([n,o,s]),2!=t.length));n++);if(2==t.length)break}if(2==t.length){if(2==t[0][0]&&3==t[0][1]&&3==t[1][0]&&2==t[1][1])return;if(3==t[0][0]&&2==t[0][1]&&2==t[1][0]&&3==t[1][1])return;if(t[0][0]==t[1][0]||t[0][1]==t[1][1])return;var l=e.getAbsolutePosition(a._objects[t[0][0]]),i=e.getAbsolutePosition(a._objects[t[1][0]]),b=e.getAbsolutePosition(e.objArr[t[0][2]]._objects[t[0][1]]),v=e.getAbsolutePosition(e.objArr[t[1][2]]._objects[t[1][1]]),h=Math.sqrt((l.x-i.x)*(l.x-i.x)+(l.y-i.y)*(l.y-i.y)),f=Math.sqrt((b.x-v.x)*(b.x-v.x)+(b.y-v.y)*(b.y-v.y)),p=0;if((p=(n=((i.x-l.x)*(v.x-b.x)+(i.y-l.y)*(v.y-b.y))/(h*f))>=1?0:n<=-1?180:Math.acos(((i.x-l.x)*(v.x-b.x)+(i.y-l.y)*(v.y-b.y))/(h*f)))/Math.PI*180<.1&&Math.abs(l.x-b.x)<3&&Math.abs(l.y-b.y)<3&&Math.abs(i.x-v.x)<3&&Math.abs(i.y-v.y)<3)return;a.rotate(a.angle-p/Math.PI*180),a.calcCoords(),a.left=a.left-(l.x-b.x),a.top=a.top-(l.y-b.y),a.calcCoords(),l=e.getAbsolutePosition(a._objects[t[0][0]]),i=e.getAbsolutePosition(a._objects[t[1][0]]),b=e.getAbsolutePosition(e.objArr[t[0][2]]._objects[t[0][1]]),v=e.getAbsolutePosition(e.objArr[t[1][2]]._objects[t[1][1]]),((n=((i.x-l.x)*(v.x-b.x)+(i.y-l.y)*(v.y-b.y))/(h*f))>=1?0:n<=-1?180:Math.acos(((i.x-l.x)*(v.x-b.x)+(i.y-l.y)*(v.y-b.y))/(h*f)))/Math.PI*180>.01&&(a.rotate(a.angle+2*p/Math.PI*180),a.left=a.left-(l.x-b.x),a.top=a.top-(l.y-b.y))}},e.getAbsolutePosition=function(e){var a=e.calcTransformMatrix();return{x:a[4],y:a[5]}},e.getOrgPos=function(e){var a=e.get("left"),t=e.get("top"),r=e.getWidth(),c=e.getHeight(),s=e.get("angle")*(Math.PI/180)*-1,o=Math.atan(r/c),n=(Math.PI/180*180-s)/2-o,l=Math.sqrt(Math.pow(r/2,2)+Math.pow(c/2,2)),i=2*(Math.sin(s/2)*l),b=Math.cos(n)*i;return{x:a+Math.sin(n)*i,y:t-b}}}};